# 결제(Stripe) 아키텍처(SSOT)

## 1) 결제 대상(예시)
- 기획사 플랜(구독) 또는 공고 등록/노출 패키지(일회성)
- 트레이너 피드백(세션 단위 결제)
- 유료 칼럼/콘텐츠(향후)

## 2) 핵심 원칙
- 결제 상태는 “클라이언트 요청”이 아니라 **Stripe Webhook**을 최종 진실로 한다.
- 모든 webhook 처리는 **idempotent** 해야 한다(중복 이벤트/재전송 대비).
- 결제/환불/정산은 감사 가능한 이벤트 로그가 필요하다.

## 3) 구현 방향(단계적)
- 초기: 기존 서비스에 `billing` 모듈로 시작(공통 라이브러리) → 확장 시 `billing-service`로 분리
- 데이터: `payment_intents`, `subscriptions`, `webhook_events`(처리 여부/리트라이)

## 3-1) 현재 구현(Phase 4 최소)
- `stripe_webhook_events` 테이블에 이벤트 원문/서명 저장
- `event_id` 유니크로 **idempotent 저장** 보장
- 서명 검증은 다음 단계에서 적용

## 4) 운영 체크리스트
- webhook 서명 검증 필수
- 성공/실패/환불/차지백 흐름 테스트 시나리오 문서화
- 장애 시 “중복 처리 없이 재처리” 가능한 설계(Replay 가능)

